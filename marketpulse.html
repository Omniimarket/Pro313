<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MarketPulse - Working Volume Profile</title>
  <style>
    /* SIMPLIFIED STYLES */
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f7fa;
    }
    #ticker-buttons { margin: 20px 0; }
    .ticker-btn {
      padding: 10px 15px;
      background: #4361ee;
      color: white;
      border: none;
      border-radius: 5px;
      margin-right: 10px;
      cursor: pointer;
    }
    #chart-container {
      width: 100%;
      height: 500px;
      background: white;
      border: 1px solid #ddd;
    }
    #signals {
      margin-top: 20px;
      padding: 15px;
      background: white;
      border: 1px solid #ddd;
    }
    .cluster-pill {
      display: inline-block;
      background: #4361ee;
      color: white;
      padding: 3px 8px;
      margin: 3px;
      border-radius: 3px;
      font-size: 0.9em;
    }
  </style>
</head>
<body>
  <h1>MarketPulse Volume Profile</h1>
  <div id="ticker-buttons"></div>
  <div id="chart-container"></div>
  <div id="signals"></div>
  <div id="debug" style="color:red; margin-top:20px;"></div>

  <!-- Using specific working version of Lightweight Charts -->
  <script src="https://cdn.jsdelivr.net/npm/lightweight-charts@3.8.0/dist/lightweight-charts.standalone.production.js"></script>
  
  <script>
    // DEBUGGING HELPER
    function debugLog(message) {
      console.log(message);
      document.getElementById('debug').innerHTML += message + '<br>';
    }

    // SIMPLIFIED DATA
    const stocks = {
      "AAPL": {
        "POC": 198.58,
        "VAL": 195.64,
        "VAH": 212.56,
        "candles": [
          { time: "2023-01-01", open: 195, high: 199, low: 194, close: 198 },
          { time: "2023-01-02", open: 198, high: 200, low: 197, close: 199 },
          { time: "2023-01-03", open: 199, high: 202, low: 198, close: 200 }
        ]
      },
      "NVDA": {
        "POC": 135.17,
        "VAL": 114.20,
        "VAH": 144.34,
        "candles": [
          { time: "2023-01-01", open: 130, high: 135, low: 129, close: 134 },
          { time: "2023-01-02", open: 134, high: 137, low: 133, close: 136 },
          { time: "2023-01-03", open: 136, high: 139, low: 135, close: 138 }
        ]
      }
    };

    // INITIALIZE WHEN READY
    document.addEventListener('DOMContentLoaded', function() {
      debugLog('DOM fully loaded');
      
      try {
        // 1. CREATE BUTTONS
        const buttonsDiv = document.getElementById('ticker-buttons');
        if (!buttonsDiv) throw new Error('Missing ticker-buttons div');
        
        Object.keys(stocks).forEach(ticker => {
          const btn = document.createElement('button');
          btn.className = 'ticker-btn';
          btn.textContent = ticker;
          btn.onclick = () => loadChart(ticker);
          buttonsDiv.appendChild(btn);
        });
        debugLog('Buttons created');

        // 2. LOAD FIRST CHART
        loadChart(Object.keys(stocks)[0]);
        
      } catch (error) {
        debugLog('Initialization error: ' + error.message);
      }
    });

    // CHART LOADING FUNCTION
    function loadChart(ticker) {
      debugLog(`Loading chart for ${ticker}`);
      
      try {
        const data = stocks[ticker];
        if (!data) throw new Error(`No data for ${ticker}`);
        
        const chartContainer = document.getElementById('chart-container');
        const signalsDiv = document.getElementById('signals');
        
        if (!chartContainer || !signalsDiv) {
          throw new Error('Missing chart container or signals div');
        }

        // CLEAR PREVIOUS CHART
        chartContainer.innerHTML = '';
        debugLog('Chart container cleared');

        // CREATE NEW CHART
        const chart = LightweightCharts.createChart(chartContainer, {
          width: chartContainer.clientWidth,
          height: chartContainer.clientHeight,
          layout: {
            backgroundColor: '#FFFFFF',
            textColor: '#191919',
          },
          grid: {
            vertLines: { color: '#f0f3fa' },
            horzLines: { color: '#f0f3fa' },
          }
        });
        debugLog('Chart instance created');

        // ADD CANDLE SERIES
        const candleSeries = chart.addCandlestickSeries({
          upColor: '#26a69a',
          downColor: '#ef5350',
          borderDownColor: '#ef5350',
          borderUpColor: '#26a69a',
          wickDownColor: '#ef5350',
          wickUpColor: '#26a69a',
        });
        debugLog('Candle series added');

        // SET DATA
        candleSeries.setData(data.candles);
        debugLog('Candle data set');

        // ADD POC LINE
        candleSeries.createPriceLine({
          price: data.POC,
          color: '#2962FF',
          lineWidth: 2,
          lineStyle: 2, // Dashed
          title: 'POC',
        });
        debugLog('POC line added');

        // UPDATE SIGNALS PANEL
        signalsDiv.innerHTML = `
          <h2>${ticker} Signals</h2>
          <p><strong>POC:</strong> $${data.POC.toFixed(2)}</p>
          <p><strong>VAL:</strong> $${data.VAL.toFixed(2)}</p>
          <p><strong>VAH:</strong> $${data.VAH.toFixed(2)}</p>
        `;
        debugLog('Signals panel updated');

        // WINDOW RESIZE HANDLER
        window.addEventListener('resize', () => {
          chart.applyOptions({
            width: chartContainer.clientWidth,
            height: chartContainer.clientHeight
          });
        });

      } catch (error) {
        debugLog('Chart loading error: ' + error.message);
      }
    }
  </script>
</body>
</html>
